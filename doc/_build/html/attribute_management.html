

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Attribute Management in Authentic2 &mdash; Authentic2 1.9.2 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.9.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Authentic2 1.9.2 documentation" href="index.html" />
    <link rel="prev" title="Configure Authentic2 as a CAS client" href="config_cas_idp.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="config_cas_idp.html" title="Configure Authentic2 as a CAS client"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Authentic2 1.9.2 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="attribute-management-in-authentic2">
<span id="attribute-management"></span><h1>Attribute Management in Authentic2<a class="headerlink" href="#attribute-management-in-authentic2" title="Permalink to this headline">¶</a></h1>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>Attribute management currently allows to configure attribute policies
associated with SAML2 service providers to define attributes that are
pushed in SAML2 successful authentication response delivered by Authentic2.</p>
<p>User attributes can be taken from LDAP directories, the user Django
profile or taken from the user Django session if Authentic2 is also configured
as a SAML2 service provider.</p>
<p>Indeed, when Authentic2 acts also as a SAML2 service provider,
attributes contained in the SAML2 assertion received from third IdP are put in
the user session.</p>
<p>Attributes can thus be proxyfied during SSO with Authentic2
configured as a SAML2 proxy.</p>
<p>The namespace of attributes received from another SAML2 IdP or pushed in the
assertion given in to service providers can be configured per attribute or per
service provider.</p>
<p>By default, the namespace and format of attributes in assertion is conformant
to the SAMLV2.0 X500/LDAP Attribute profile:</p>
<div class="highlight-python"><pre>&lt;saml:Attribute
    xmlns:x500="urn:oasis:names:tc:SAML:2.0:profiles:attribute:X500"
    NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:uri"
    Name="urn:oid:2.5.4.42" FriendlyName="givenName"&gt;
    &lt;saml:AttributeValue xsi:type="xs:string"
        x500:Encoding="LDAP"&gt;Mikaël&lt;/saml:AttributeValue&gt;
&lt;/saml:Attribute&gt;</pre>
</div>
<p>But the <a class="reference external" href="http://schemas.xmlsoap.org/ws/2005/05/identity/claims">http://schemas.xmlsoap.org/ws/2005/05/identity/claims</a> from the ISI
profile can also be used, for instance:</p>
<div class="highlight-python"><pre>&lt;saml:Attribute
    NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:uri"
    Name="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname"
    FriendlyName="First Name"&gt;
    &lt;saml:AttributeValue&gt;Mikaël&lt;/saml:AttributeValue&gt;
&lt;/saml:Attribute&gt;</pre>
</div>
</div>
<div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<div class="section" id="configure-sources-of-attributes">
<h3>Configure sources of attributes<a class="headerlink" href="#configure-sources-of-attributes" title="Permalink to this headline">¶</a></h3>
<p>The source of attributes for authentic2 are of two kinds. The LDAP sources and
the user django profile.</p>
<div class="section" id="declare-the-django-profile-source">
<h4>Declare the Django profile source<a class="headerlink" href="#declare-the-django-profile-source" title="Permalink to this headline">¶</a></h4>
<p>Add an attribute source named USER_PROFILE with namespace &#8216;Default&#8217;.</p>
<p>Then, it is necessary that users create their profile.</p>
</div>
<div class="section" id="add-an-ldap-source">
<h4>Add an LDAP Source<a class="headerlink" href="#add-an-ldap-source" title="Permalink to this headline">¶</a></h4>
<p>For LDAP sources, objects of type &#8216;LDAPSource&#8217; must be created.</p>
<p><strong>Even if the authentication is based on LDAP authentification, thus that a
server is configured in settings.py, it is
necessary to create a corresponding &#8216;LDAPSource&#8217; to use it as a source of
attribute.</strong></p>
<ol class="arabic simple">
<li>Go to http[s]://your.domain.com/admin/attribute_aggregator/ldapsource/add/</li>
<li>Fill form fields</li>
</ol>
<p>Only the field Name, Server, User, Password, Base and Port are used for now.
<strong>The namespace of LDAP source must be kept to &#8216;Default&#8217;, since the system
namespace is based on LDAP.</strong></p>
<img alt="_images/ldapsource.png" src="_images/ldapsource.png" style="width: 800px;" />
<ol class="arabic simple" start="3">
<li>Save</li>
</ol>
<img alt="_images/ldapsource_saved.png" src="_images/ldapsource_saved.png" style="width: 800px;" />
</div>
<div class="section" id="manage-user-distinguished-names-in-ldap-directories">
<h4>Manage user distinguished names in LDAP directories<a class="headerlink" href="#manage-user-distinguished-names-in-ldap-directories" title="Permalink to this headline">¶</a></h4>
<p>To find the user in a LDAP directory, authentic2 must know its distinguished
name (DN). If this LDAP has been used when the user has authenticated,
Authentic2 learn the user DN. Nothing has to be done from this point of view.</p>
<p>However, if it is expected that user attributes be taken in a directory that
is not used by the user for authentication, it is necessary to manually
indicate to Authentic2 what is the user DN in the directory. For this, a
user alias in source is created for the user:</p>
<ol class="arabic simple">
<li>Go to http[s]://your.domain.com/admin/attribute_aggregator/useraliasinsource/add/</li>
<li>Fill form fields</li>
</ol>
<img alt="_images/alias_in_source.png" src="_images/alias_in_source.png" style="width: 800px;" />
<ol class="arabic simple" start="3">
<li>Save</li>
</ol>
<img alt="_images/alias_in_source_saved.png" src="_images/alias_in_source_saved.png" style="width: 800px;" />
</div>
</div>
<div class="section" id="configure-attributes-pushed-to-saml2-service-providers-in-sso-response">
<h3>Configure attributes pushed to SAML2 service providers in SSO response<a class="headerlink" href="#configure-attributes-pushed-to-saml2-service-providers-in-sso-response" title="Permalink to this headline">¶</a></h3>
<p>Reminder:</p>
<ul class="simple">
<li>The default name format in SAML2 assertions is URI</li>
<li>The default namespace called &#8216;Default&#8217; is LDAP</li>
</ul>
<p>In summary:</p>
<ol class="arabic simple">
<li>Create attribute items indicating an attribute name, a source, the name format expected and the namespace expected for the attribute name and friendly name if any.</li>
<li>Create a named list of attribute items.</li>
<li>Create an attribute policy and associate the previous list or associate the previous list to a existing attribute policy.</li>
<li>Associate the policy to a service provider.</li>
</ol>
<div class="section" id="create-attribute-items">
<h4>Create attribute items<a class="headerlink" href="#create-attribute-items" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li>Go to http[s]://your.domain.com/admin/idp/attributeitem/add/</li>
<li>Fill form fields</li>
</ol>
<img alt="_images/attribute_item.png" src="_images/attribute_item.png" style="width: 800px;" />
<ol class="arabic simple" start="3">
<li>Save</li>
</ol>
<img alt="_images/attribute_item_saved.png" src="_images/attribute_item_saved.png" style="width: 800px;" />
</div>
<div class="section" id="create-a-named-list-of-attribute-items">
<h4>Create a named list of attribute items<a class="headerlink" href="#create-a-named-list-of-attribute-items" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li>Go to http[s]://your.domain.com/admin/idp/attributelist/add/</li>
<li>Name the list and add items to list</li>
</ol>
<img alt="_images/attribute_list.png" src="_images/attribute_list.png" style="width: 800px;" />
<ol class="arabic simple" start="3">
<li>Save</li>
</ol>
<img alt="_images/attribute_list_saved.png" src="_images/attribute_list_saved.png" style="width: 800px;" />
</div>
<div class="section" id="create-or-modify-an-attribute-policy">
<h4>Create or modify an attribute policy<a class="headerlink" href="#create-or-modify-an-attribute-policy" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li>Go to http[s]://your.domain.com/admin/idp/attributepolicy/add/</li>
<li>Add list to the policy</li>
</ol>
<img alt="_images/policy_pull.png" src="_images/policy_pull.png" style="width: 800px;" />
<ol class="arabic simple" start="3">
<li>Save</li>
</ol>
<img alt="_images/policy_pull_saved.png" src="_images/policy_pull_saved.png" style="width: 800px;" />
</div>
<div class="section" id="associate-the-policy-to-a-service-provider">
<h4>Associate the policy to a service provider<a class="headerlink" href="#associate-the-policy-to-a-service-provider" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li>Go to http[s]://your.domain.com/admin/saml/libertyprovider/1/</li>
<li>Add policy to the service provider</li>
</ol>
<img alt="_images/sp_policy_pull.png" src="_images/sp_policy_pull.png" style="width: 800px;" />
<ol class="arabic simple" start="3">
<li>Save</li>
</ol>
<img alt="_images/sp_policy_pull_saved.png" src="_images/sp_policy_pull_saved.png" style="width: 800px;" />
<ol class="arabic simple" start="4">
<li>The display name of the policy has changed</li>
</ol>
<img alt="_images/policy_pull_renamed.png" src="_images/policy_pull_renamed.png" style="width: 800px;" />
</div>
</div>
<div class="section" id="handle-attributes-provided-by-other-identity-providers-proxy-attributes">
<h3>Handle attributes provided by other Identity providers, proxy attributes<a class="headerlink" href="#handle-attributes-provided-by-other-identity-providers-proxy-attributes" title="Permalink to this headline">¶</a></h3>
<p>Link to configure first Authentic as a sp to have attributes in session</p>
<p>Add a source if mapping set to true</p>
</div>
</div>
<div class="section" id="modifying-supported-namespaces-and-attribute-name-mappings">
<h2>Modifying supported namespaces and attribute name mappings<a class="headerlink" href="#modifying-supported-namespaces-and-attribute-name-mappings" title="Permalink to this headline">¶</a></h2>
<p>TBD</p>
</div>
<div class="section" id="explanation-draft">
<h2>Explanation (Draft)<a class="headerlink" href="#explanation-draft" title="Permalink to this headline">¶</a></h2>
<div class="section" id="attribute-aggegrator-module">
<h3>Attribute aggegrator module<a class="headerlink" href="#attribute-aggegrator-module" title="Permalink to this headline">¶</a></h3>
<p>The core attribute management is based on the attribute aggregator module.</p>
<div class="section" id="intro">
<h4>Intro<a class="headerlink" href="#intro" title="Permalink to this headline">¶</a></h4>
<p>Attribute aggregator provides a main Model class called UserAttributeProfile,
functions to load attributes and extract attributes.</p>
<p>The mapping between attribute namespaces is built-in and depends on a unique
file (mapping.py).</p>
<p>A main schema is defined and is based on LDAP/X500 for naming. The support
of <a class="reference external" href="http://schemas.xmlsoap.org/ws/2005/05/identity/claims">http://schemas.xmlsoap.org/ws/2005/05/identity/claims</a> is partly complete.</p>
<p>Source of attributes are connected with attribute loading functions using
signals.</p>
</div>
<div class="section" id="faq">
<h4>FAQ<a class="headerlink" href="#faq" title="Permalink to this headline">¶</a></h4>
<p>Why not use the Django User profile?</p>
<p>The django user profile needs to define attributes as class attributes and
then support form filling or mapping with LDAP.</p>
<p>That is useful and may be used, especially because the profile can be used as
a source of attribute to load in the attribute_aggregator profile.</p>
<p>The attribute_aggregator profile allow to load multivalued attributes from any
source supported (LDAP, Django profile and attributes in Django session for
now) from any namespace defined in mapping.py (LDAP/X500 and claims for now).</p>
<p>The profile can be loaded giving a source or a list of attribute, or can be
from any known source, or with a dictionnary.</p>
<p>Attributes can be extracted with many functions in any namespace supported.</p>
</div>
<div class="section" id="quick-explanation">
<h4>Quick explanation<a class="headerlink" href="#quick-explanation" title="Permalink to this headline">¶</a></h4>
<p>The schema is defined in mapping.py and is made of definitions like this:</p>
<div class="highlight-python"><pre>"sn": {
    "oid": "2.5.4.4",
    "display_name": _("sn surname"),
    "alias": ['surname'],
    "profile_field_name": 'last_name',
    "type": "http://www.w3.org/2001/XMLSchema#string",
    "namespaces": {
        "http://schemas.xmlsoap.org/ws/2005/05/identity/claims": {
            "identifiers":
                [
        "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname",
                ],
            "friendly_names":
                [
            "Last Name",
                ],
        }
    }
},</pre>
</div>
<p>The profile store all the data in a text field taht contains a cPickle list of
instances of the class AttributeData.</p>
<p>The profile is attached to a user and then can be created or loaded with:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">profile</span> <span class="o">=</span> <span class="n">load_or_create_user_profile</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
</pre></div>
</div>
<p>User may be None to create a temporary profile for an anonymous user. But
that need a DB cleaning function not implemented.</p>
</div>
<div class="section" id="the-model-userattributeprofile">
<h4>The model <em>UserAttributeProfile</em><a class="headerlink" href="#the-model-userattributeprofile" title="Permalink to this headline">¶</a></h4>
<p>The model &#8216;UserAttributeProfile&#8217; can be attached to a user and then persist
(as a Model).</p>
<p>When the profile is loaded, all data stored are removed expect if the
the data has an expiration date later.</p>
<p>The profile provide several methods to store and extract attributes.</p>
<p>All the methods to add attributes are based on a main one accepting a
dictionnary of attribute is parameters &#8216;load_by_dic()&#8217;. The other methods
(&#8216;load_listed_attributes()&#8217;, &#8216;load_greedy()&#8217;) send a signal with a list of
attributes (listed_attributes_call) or not (any_attributes_call) to grab a
dictionnary. The list is given with the definition name, oid or friendly name
of the attribute in the system namespace.</p>
<p>Into the dictionnary, attributes are given with their name, oid or friendly
name in the default namespace or with their name in a namepsace. An expiration
date can also be given (ISO8601 format), if none, attribute will be deleted at
next profile loading. The dictionnary format is as follows:</p>
<div class="highlight-python"><pre>attributes = dict()
data_from_source = list()
a1 = dict()
    a1['oid'] = definition_name
Or
    a1['definition'] = definition_name
        definition may be the definition name like 'gn'
        or an alias like 'givenName'
Or
    a1['name'] = attribute_name_in_ns
    a1['namespace'] = ns_name
a1['expiration_date'] = date
a1['values'] = list_of_values
data_from_source.append(a1)
...
data_from_source.append(a2)
attributes[source_name] = data_from_source</pre>
</div>
<p>Getters are defined to extract data from a profile. Only AttributeData
instances are extracted that assume that any attribute namespace can be used.</p>
<ul class="simple">
<li>get_data_of_definition(definition)</li>
</ul>
<p>Return a list of AttributeData instances corresponding to the definition
given.</p>
<ul class="simple">
<li>get_freshest_data_of_definition(definition)</li>
</ul>
<p>Return the freshest AttributeData instance. If multiple with no or same exp
date, random. Should use the creation date soon.</p>
<ul class="simple">
<li>get_data_of_source</li>
</ul>
<p>Return a list of AttributeData instances corresponding to the source given.</p>
<ul class="simple">
<li>get_data_of_source_by_name</li>
</ul>
<p>Idem but source name is given, not a Source instance.</p>
<ul class="simple">
<li>get_data_of_definition_and_source</li>
</ul>
<p>Return a list of AttributeData instances corresponding to the definition and
source given.</p>
<ul class="simple">
<li>get_data_of_definition_and_source_by_name</li>
</ul>
<p>Idem but source name is given, not a Source instance.</p>
</div>
</div>
<div class="section" id="saml2-attribute-representation-in-assertions">
<h3>SAML2 attribute representation in assertions<a class="headerlink" href="#saml2-attribute-representation-in-assertions" title="Permalink to this headline">¶</a></h3>
<p>SAML2 attribute profile (saml-profiles-2.0-os - Section 8) defines two kind of
attribute element syntax in the attribute statement of assertions, also
called <em>name format</em>:</p>
<ul>
<li><p class="first">BASIC:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">NameFormat</span><span class="o">=</span><span class="s">&quot;urn:oasis:names:tc:SAML:2.0:attrname-format:basic&quot;</span>
</pre></div>
</div>
</li>
<li><p class="first">URI:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">NameFormat</span><span class="o">=</span><span class="s">&quot;urn:oasis:names:tc:SAML:2.0:attrname-format:uri&quot;</span>
</pre></div>
</div>
</li>
</ul>
<p><em>URI should be used when attributes have &#8220;universally&#8221; known unique names
like OID.</em></p>
<p>Example:</p>
<div class="highlight-python"><pre>&lt;saml:Attribute NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:basic"
    Name="FirstName"&gt;
    &lt;saml:AttributeValue xsi:type="xs:string"&gt;By-Tor&lt;/saml:AttributeValue&gt;
&lt;/saml:Attribute&gt;

&lt;saml:Attribute
    xmlns:x500="urn:oasis:names:tc:SAML:2.0:profiles:attribute:X500"
    NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:uri"
    Name="urn:oid:2.5.4.42" FriendlyName="givenName"&gt;
    &lt;saml:AttributeValue xsi:type="xs:string"
        x500:Encoding="LDAP"&gt;Steven&lt;/saml:AttributeValue&gt;
&lt;/saml:Attribute&gt;</pre>
</div>
<div class="section" id="basic">
<h4>BASIC<a class="headerlink" href="#basic" title="Permalink to this headline">¶</a></h4>
<p>Two &lt;Attribute&gt; elements refer to the same SAML attribute if and only if the
values of their Name XML attributes are equal in the sense of Section 3.3.6 of
[Schema2].</p>
<p>No additional XML attributes are defined for use with the &lt;Attribute&gt; element.</p>
<p>The schema type of the contents of the &lt;AttributeValue&gt; element MUST be drawn
from one of the types defined in Section 3.3 of [Schema2]. The xsi:type
attribute MUST be present and be given the appropriate value.</p>
</div>
<div class="section" id="x-500-ldap-attribute-profile-uri">
<h4>X.500/LDAP Attribute Profile (URI)<a class="headerlink" href="#x-500-ldap-attribute-profile-uri" title="Permalink to this headline">¶</a></h4>
<p><strong>Extracted from the SAML2 core specifications</strong></p>
<p>Two &lt;Attribute&gt; elements refer to the same SAML attribute if and only if their
Name XML attribute values are equal in the sense of [RFC3061]. The
FriendlyName attribute plays no role in the comparison.</p>
<p>Directory attribute type definitions for use in native X.500 directories
specify the syntax of the attribute using ASN.1 [ASN.1]. For use in LDAP,
directory attribute definitions additionally include an LDAP syntax which
specifies how attribute or assertion values conforming to the syntax are to be
represented when transferred in the LDAP protocol (known as an LDAP-specific
encoding). The LDAP-specific encoding commonly produces Unicode characters in
UTF-8 form. This SAML attribute profile specifies the form of SAML attribute
values only for those directory attributes which have LDAP syntaxes. Future
extensions to this profile may define attribute value formats for directory
attributes whose syntaxes specify other encodings.</p>
<p>To represent the encoding rules in use for a particular attribute value, the
&lt;AttributeValue&gt; element MUST contain an XML attribute named Encoding defined
in the XML namespace <a class="reference external" href="urn:oasis:names:tc:SAML:2.0:profiles:attribute:X500">urn:oasis:names:tc:SAML:2.0:profiles:attribute:X500</a>.</p>
<p>For any directory attribute with a syntax whose LDAP-specific encoding
exclusively produces UTF-8 character strings as values, the SAML attribute
value is encoded as simply the UTF-8 string itself, as the content of the
&lt;AttributeValue&gt; element, with no additional whitespace.
In such cases, the xsi:type XML attribute MUST be set to xs:string.
The profile-specific Encoding XML attribute is provided, with a value of LDAP.</p>
<p>The AttributeData instances have a field expiration_data. It the profile
exists, obsolete data are removed at loading.</p>
</div>
</div>
<div class="section" id="when-authentic-2-deals-with-attributes-and-needs-mapping">
<h3>When authentic 2 deals with attributes and needs mapping?<a class="headerlink" href="#when-authentic-2-deals-with-attributes-and-needs-mapping" title="Permalink to this headline">¶</a></h3>
<p>Authentic2 behaves as an attribute provider:
* At the SSO login
* When an attribute request is received</p>
<p>Authentic requests (e.g. by soap) are not yet supported.</p>
<div class="section" id="when-authentic2-behaves-as-an-attribute-provider-at-sso-login">
<h4>When Authentic2 behaves as an attribute provider at SSO login<a class="headerlink" href="#when-authentic2-behaves-as-an-attribute-provider-at-sso-login" title="Permalink to this headline">¶</a></h4>
<p>At a SSO request, just before responding to the service provider, the saml2
idp module sends the signal &#8216;add_attributes_to_response&#8217; giving the SP entity
ID.</p>
<p>The signal is connected to the function &#8216;provide_attributes_at_sso()&#8217; in
charge of providing the attributes at the SSO for this SP.</p>
<p><strong>Attributes sources are of two kinds. The first ones are the sources that can
be requested by the IdP with a syncrhonous binding without user intercations.
These sources are called pull sources. They are for now limited to LDAP
sources. The other ones are sources are asyncrhonous bindings, usually
requiring user interactions. These sources are called push sources. They are
now limited to the attributes provided at SSO requests when the IdP acts as a
SAML2 SP. There attributes are put/found in the Django session.</strong></p>
<p>Each source in the system is declared with an instance of the AttributeSource
model. We&#8217;ll see later that to forward attributes of push sources it is not
necessary that a source is declared in some circumstances.</p>
<p>To manage these sources an attribute policy is attached to services providers.
Then the service provider model must be extended with a attribute
attributes_at_sso_policy. The service provider must send the signal
&#8216;add_attributes_to_response&#8217;.</p>
<p>The implementation is actually done for SAML2 providers.</p>
<p><strong>In such a policy attributes from pull and push sources are treated
differently.</strong></p>
<p><strong>For pull sources, a list of attributes is indicated. Either an attribute is
searched in all the pull sources and whatever attribute value found is
returned. Or each attribute is indicated with a source. With each attribute is
indicated the output format and namespace.</strong></p>
<p><strong>The policy may also indicate that all the attributes in the Django session
must be forwarded. Then, no AttributeSource instance is required. All the
attributes are then forwarded without treating input namespace considerations.
When an AttributeSource instance is found, the input namespace of this source
is considered. An option can then be set to tell that the output format and
namespace must be taken. A list of attribute can also be given.
This list can be use to filter attributes to forward without or without taking
care of the source. The output namespace and format can also be trated per
attribute.</strong></p>
<p>If the namespace is default, the attribute names will be taken from the
system namespace. In BASIC the name will be the definition name. In URI, the
Name will be the OID in urn format and the friendly name will be the
definition name. If a namespace is given, the first identifier of this
attribute is taken as Name in BASIC. In URI, the same and the first friendly
name is taken.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">LibertyServiceProvider</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">attribute_policy</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">AttributePolicy</span><span class="p">,</span>
            <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Attribute policy&quot;</span><span class="p">),</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">AttributePolicy</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c"># List of attributes to provide from pull sources at SSO Login.</span>
    <span class="c"># If an attribute is indicate without a source, from any source.</span>
    <span class="c"># The output format and namespace is given by each attribute.</span>
    <span class="n">attribute_list_for_sso_from_pull_sources</span> <span class="o">=</span> \
        <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">LibertyAttributeMap</span><span class="p">,</span>
        <span class="n">related_name</span> <span class="o">=</span> <span class="s">&quot;attributes of pull sources&quot;</span><span class="p">,</span>
        <span class="n">blank</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">null</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>

    <span class="c"># Set to true for proxying attributes from pull sources at SSO Login.</span>
    <span class="c"># Attributes are in session.</span>
    <span class="c"># All attributes are forwarded as is except if the parameter</span>
    <span class="c"># &#39;attribute_list_for_sso_from_push_sources&#39; is initialized</span>
    <span class="n">forward_attributes_from_pull_sources</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c"># Map attributes in session</span>
    <span class="c"># forward_attributes_in_session must be true</span>
    <span class="c"># At False, all attributes are forwarded as is</span>
    <span class="c"># At true, look for the namespace of the source for input, If not found,</span>
    <span class="c"># system namespace. Look for the options attribute_name_format and</span>
    <span class="c"># output_namespace of the attribute policy for output.</span>
    <span class="n">map_attributes_from_pull_sources</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c"># ATTRIBUTE_VALUE_FORMATS[0] =&gt;</span>
    <span class="c">#    (lasso.SAML2_ATTRIBUTE_NAME_FORMAT_BASIC, &#39;SAMLv2 BASIC&#39;)</span>
    <span class="n">output_name_format</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">choices</span> <span class="o">=</span> <span class="n">ATTRIBUTE_VALUE_FORMATS</span><span class="p">,</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">ATTRIBUTE_VALUE_FORMATS</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c">#ATTRIBUTES_NS[0] =&gt; (&#39;Default&#39;, &#39;Default&#39;)</span>
    <span class="n">output_namespace</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">choices</span> <span class="o">=</span> <span class="n">ATTRIBUTES_NS</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="n">ATTRIBUTES_NS</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c"># Filter attributes pushed from source.</span>
    <span class="n">source_filter_for_sso_from_push_sources</span> <span class="o">=</span> \
        <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">AttributeSource</span><span class="p">,</span>
        <span class="n">related_name</span> <span class="o">=</span> <span class="s">&quot;attributes of pull sources&quot;</span><span class="p">,</span>
        <span class="n">blank</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">null</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>

    <span class="c"># List of attributes to filter from pull sources at SSO Login.</span>
    <span class="n">attribute_filter_for_sso_from_push_sources</span> <span class="o">=</span> \
        <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">LibertyAttributeMap</span><span class="p">,</span>
        <span class="n">related_name</span> <span class="o">=</span> <span class="s">&quot;attributes of pull sources&quot;</span><span class="p">,</span>
        <span class="n">blank</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">null</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>

    <span class="c"># The sources of attributes of the previous list are considered.</span>
    <span class="c"># May be used conjointly with &#39;source_filter_for_sso_from_push_sources&#39;</span>
    <span class="n">filter_source_of_filtered_attributes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c"># To map the attributes of forwarded attributes with the defaut output</span>
    <span class="c"># format and namespace, use &#39;map_attributes_from_pull_sources&#39;</span>
    <span class="c"># Use the following option to use the output format and namespace</span>
    <span class="c"># indicated for each attribute.</span>
    <span class="n">map_attributes_of_filtered_attributes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="c"># Set to true to take in account missing required attributes</span>
    <span class="n">send_error_and_no_attrs_if_missing_required_attrs</span> <span class="o">=</span> \
        <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;attribute options policy&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;attribute options policies&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">AttributeList</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">AttributeItem</span><span class="p">,</span>
        <span class="n">related_name</span> <span class="o">=</span> <span class="s">&quot;attributes of the list&quot;</span><span class="p">,</span>
        <span class="n">blank</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">null</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">AttributeItem</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">attribute_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">choices</span> <span class="o">=</span> <span class="n">ATTRIBUTES</span><span class="p">,</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">ATTRIBUTES</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c"># ATTRIBUTE_VALUE_FORMATS[0] =&gt;</span>
    <span class="c">#    (lasso.SAML2_ATTRIBUTE_NAME_FORMAT_BASIC, &#39;SAMLv2 BASIC&#39;)</span>
    <span class="n">output_attribute_name_format</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">choices</span> <span class="o">=</span> <span class="n">ATTRIBUTE_VALUE_FORMATS</span><span class="p">,</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">ATTRIBUTE_VALUE_FORMATS</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c">#ATTRIBUTES_NS[0] =&gt; (&#39;Default&#39;, &#39;Default&#39;)</span>
    <span class="n">output_namespace</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">choices</span> <span class="o">=</span> <span class="n">ATTRIBUTES_NS</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="n">ATTRIBUTES_NS</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">required</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">AttributeSource</span><span class="p">,</span> <span class="n">blank</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">null</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>A list of attributes can also be taken from the service provider metadata and
added to &#8216;attribute_list_for_sso_from_pull_sources&#8217;. The namespace may be
extracted from the metadata. This namespace is then used to look for the
corresponding definition and then to provide the attribute in the right
namespace. Read attributes from metadata is not yet supported.</p>
<p>For the attributes of pull sources, once the list of attributes is defined,
They are loaded in the user profile.</p>
<p>As explained before the attribute_aggregator loading function send signals to
grab dictionnary of attributes. Up to know, only the ldap loading function are
connected to these signals. The namespace of LDAP sources is assumed to be
the same as the system namespace. There is here then no mapping needed. Other
kind of sources than LDAP can be defined in attribute aggregator.</p>
<p>To grab attributes from a LDAP the user dn in the LDAP  or at least a local
identifier in the LDAP is required. For this purpose, each user has alias
associated with LDAP source. These aliases must their DN in the LDAP. When
the authentication LDAP backend will be taken in account, the dn will be taken
direclty from the user Model instance.</p>
<p>Each LDAP sources are declared with the binding parameters. The LDAP namespace
is always &#8216;Default&#8217;.</p>
<p>If an attribute to load is not found and is required the answer should report
an error (Not yet implemented).</p>
<p>Attributes in response can also be provided with other means than from an LDAP
source. Attributes can be put in the user Django session and then loaded in
the profile. An option of the service provier indicate if attributes in the
session must be provided to the service provider.</p>
<p>To have the attribute loaded from the session, they must be provided in the
session as follows:
request.session[&#8216;attributes&#8217;][source_name] = list()</p>
<p>The source_name must be the name of an existing instance of an
&#8216;AttributeSource&#8217;. Such an instance contains a field namespace indicating the
namespace of attributes.</p>
<p>This is currently implemented only for the SAML2 service provider module of
authentic2. Authsaml2, the SP module, parse the assertion and put the
attributes in the session.</p>
<div class="highlight-python"><pre>if not 'multisource_attributes' in request.session:
    request.session['attributes'] = dict{}
request.session['multisource_attributes'] \
    [login.assertion.issuer.content] = attributes</pre>
</div>
<p>Then, Authentic2 can be used as a SAML2 proxy forwarding attributes in
assertion, eventually doing a namespace mapping. For this, the option
forward attributes in sesion must be set (by default False).</p>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Attribute Management in Authentic2</a><ul>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#configuration">Configuration</a><ul>
<li><a class="reference internal" href="#configure-sources-of-attributes">Configure sources of attributes</a><ul>
<li><a class="reference internal" href="#declare-the-django-profile-source">Declare the Django profile source</a></li>
<li><a class="reference internal" href="#add-an-ldap-source">Add an LDAP Source</a></li>
<li><a class="reference internal" href="#manage-user-distinguished-names-in-ldap-directories">Manage user distinguished names in LDAP directories</a></li>
</ul>
</li>
<li><a class="reference internal" href="#configure-attributes-pushed-to-saml2-service-providers-in-sso-response">Configure attributes pushed to SAML2 service providers in SSO response</a><ul>
<li><a class="reference internal" href="#create-attribute-items">Create attribute items</a></li>
<li><a class="reference internal" href="#create-a-named-list-of-attribute-items">Create a named list of attribute items</a></li>
<li><a class="reference internal" href="#create-or-modify-an-attribute-policy">Create or modify an attribute policy</a></li>
<li><a class="reference internal" href="#associate-the-policy-to-a-service-provider">Associate the policy to a service provider</a></li>
</ul>
</li>
<li><a class="reference internal" href="#handle-attributes-provided-by-other-identity-providers-proxy-attributes">Handle attributes provided by other Identity providers, proxy attributes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#modifying-supported-namespaces-and-attribute-name-mappings">Modifying supported namespaces and attribute name mappings</a></li>
<li><a class="reference internal" href="#explanation-draft">Explanation (Draft)</a><ul>
<li><a class="reference internal" href="#attribute-aggegrator-module">Attribute aggegrator module</a><ul>
<li><a class="reference internal" href="#intro">Intro</a></li>
<li><a class="reference internal" href="#faq">FAQ</a></li>
<li><a class="reference internal" href="#quick-explanation">Quick explanation</a></li>
<li><a class="reference internal" href="#the-model-userattributeprofile">The model <em>UserAttributeProfile</em></a></li>
</ul>
</li>
<li><a class="reference internal" href="#saml2-attribute-representation-in-assertions">SAML2 attribute representation in assertions</a><ul>
<li><a class="reference internal" href="#basic">BASIC</a></li>
<li><a class="reference internal" href="#x-500-ldap-attribute-profile-uri">X.500/LDAP Attribute Profile (URI)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#when-authentic-2-deals-with-attributes-and-needs-mapping">When authentic 2 deals with attributes and needs mapping?</a><ul>
<li><a class="reference internal" href="#when-authentic2-behaves-as-an-attribute-provider-at-sso-login">When Authentic2 behaves as an attribute provider at SSO login</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="config_cas_idp.html"
                        title="previous chapter">Configure Authentic2 as a CAS client</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/attribute_management.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="config_cas_idp.html" title="Configure Authentic2 as a CAS client"
             >previous</a> |</li>
        <li><a href="index.html">Authentic2 1.9.2 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Mikaël Ates.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.
    </div>
  </body>
</html>